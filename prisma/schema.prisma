// DispatchHub — Prisma Schema
// All core entities from BuildSpec v1.0

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─────────────────────────────────────────────────────────
// TRUCKS / FLEET
// ─────────────────────────────────────────────────────────

model Truck {
  id              String       @id @default(cuid())
  name            String       @unique           // "Packer 11", "Box Truck 5"
  type            TruckType
  year            String?
  make            String?
  model           String?
  vin             String?
  status          TruckStatus  @default(AVAILABLE)
  currentLocation String?
  
  // IntelliShift sync
  intellishiftId  String?      @unique
  lastGpsLat      Float?
  lastGpsLng      Float?
  lastGpsUpdate   DateTime?

  assignedDriverId String? @unique
  assignedDriver   Worker?     @relation("TruckDriver", fields: [assignedDriverId], references: [id])

  jobs            CartingJob[]
  projectAssignments ProjectTruck[]
  routes          Route[]

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([status])
  @@index([type])
}

enum TruckType {
  BOX_TRUCK
  CONTAINER
  PACKER
  ROLL_OFF
  SERVICE
  VAN
}

enum TruckStatus {
  AVAILABLE
  EN_ROUTE
  ON_SITE
  MAINTENANCE
  OUT_OF_SERVICE
}

// ─────────────────────────────────────────────────────────
// WORKERS / CREW
// ─────────────────────────────────────────────────────────

model Worker {
  id               String        @id @default(cuid())
  name             String
  role             WorkerRole
  status           WorkerStatus  @default(AVAILABLE)
  phone            String
  email            String        @unique
  certifications   String[]      // ["CDL-A", "OSHA-30", "Asbestos Handler"]
  hireDate         DateTime
  photo            String?       // URL to photo for facial recognition
  emergencyContact String?
  performanceNotes String?

  currentAssignment String?

  // Relations
  assignedTruck    Truck?        @relation("TruckDriver")
  driverJobs       CartingJob[]  @relation("JobDriver")
  workerJobs       JobWorker[]
  projectAssignments ProjectWorker[]
  clockHistory     ClockEntry[]
  jobHistory       JobHistory[]

  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  @@index([status])
  @@index([role])
}

enum WorkerRole {
  DRIVER
  LABORER
  FOREMAN
  OPERATOR
}

enum WorkerStatus {
  AVAILABLE
  ON_SITE
  EN_ROUTE
  OFF_DUTY
  OUT_SICK
  VACATION
}

model ClockEntry {
  id        String   @id @default(cuid())
  workerId  String
  worker    Worker   @relation(fields: [workerId], references: [id])
  clockIn   DateTime
  clockOut  DateTime?
  location  String?
  method    String?  // "manual", "facial-recognition", "gps"

  @@index([workerId, clockIn])
}

// ─────────────────────────────────────────────────────────
// CARTING JOBS
// ─────────────────────────────────────────────────────────

model CartingJob {
  id            String       @id @default(cuid())
  type          JobType
  status        JobStatus    @default(SCHEDULED)
  customer      String
  address       String
  borough       Borough
  date          DateTime     @db.Date
  time          String       // "07:00", "13:30"
  containerSize String?      // "20yd", "30yd", "40yd"
  notes         String?
  source        IntakeSource
  priority      Priority     @default(NORMAL)

  // Assignments
  truckId       String?
  truck         Truck?       @relation(fields: [truckId], references: [id])
  driverId      String?
  driver        Worker?      @relation("JobDriver", fields: [driverId], references: [id])
  workers       JobWorker[]

  // Project link (if job is part of a demo project)
  projectId     String?
  project       DemoProject? @relation(fields: [projectId], references: [id])

  // Intake origin
  intakeItemId  String?
  intakeItem    IntakeItem?  @relation(fields: [intakeItemId], references: [id])

  // Confirmation tracking
  confirmations Confirmation[]

  // Route inclusion
  routeStops    RouteStop[]

  // History
  history       JobHistory[]
  changeLogs    ChangeLog[]

  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@index([date, status])
  @@index([truckId, date])
  @@index([driverId, date])
  @@index([projectId])
  @@index([borough])
}

model JobWorker {
  id       String     @id @default(cuid())
  jobId    String
  job      CartingJob @relation(fields: [jobId], references: [id], onDelete: Cascade)
  workerId String
  worker   Worker     @relation(fields: [workerId], references: [id])

  @@unique([jobId, workerId])
}

model JobHistory {
  id       String   @id @default(cuid())
  jobId    String
  job      CartingJob @relation(fields: [jobId], references: [id])
  workerId String
  worker   Worker   @relation(fields: [workerId], references: [id])
  date     DateTime @db.Date
  role     String   // What role the worker filled

  @@index([workerId])
}

enum JobType {
  PICKUP
  DROP_OFF
  DUMP_OUT
  SWAP
  HAUL
}

enum JobStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  DELAYED
}

enum Borough {
  MANHATTAN
  BROOKLYN
  QUEENS
  BRONX
  STATEN_ISLAND
}

enum IntakeSource {
  PHONE
  EMAIL
  FORM
}

enum Priority {
  NORMAL
  HIGH
  URGENT
}

// ─────────────────────────────────────────────────────────
// INTAKE PIPELINE
// ─────────────────────────────────────────────────────────

model IntakeItem {
  id           String       @id @default(cuid())
  source       IntakeSource
  rawContent   String       @db.Text  // Original transcription, email body, or form data
  audioUrl     String?                // Twilio recording URL for phone calls

  // AI-parsed fields
  parsedCustomer      String?
  parsedPhone         String?
  parsedEmail         String?
  parsedServiceType   String?
  parsedAddress       String?
  parsedDate          String?
  parsedTime          String?
  parsedContainerSize String?
  parsedNotes         String?

  confidence   Float        // 0-100, AI confidence score
  status       IntakeStatus @default(PENDING)

  // Links
  jobs         CartingJob[]

  receivedAt   DateTime     @default(now())
  reviewedAt   DateTime?
  reviewedBy   String?

  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@index([status])
  @@index([receivedAt])
}

enum IntakeStatus {
  PENDING
  NEEDS_REVIEW
  FLAGGED
  APPROVED
  DECLINED
  ON_HOLD
}

// ─────────────────────────────────────────────────────────
// DEMO PROJECTS
// ─────────────────────────────────────────────────────────

model DemoProject {
  id             String        @id @default(cuid())
  name           String
  customer       String
  address        String
  borough        Borough
  phase          ProjectPhase  @default(PLANNING)
  startDate      DateTime      @db.Date
  endDate        DateTime      @db.Date
  cartingNeeds   String?       @db.Text
  notes          String?       @db.Text

  // Relations
  assignedWorkers ProjectWorker[]
  assignedTrucks  ProjectTruck[]
  jobs            CartingJob[]
  chatMessages    ProjectChat[]

  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@index([phase])
  @@index([borough])
}

model ProjectWorker {
  id        String      @id @default(cuid())
  projectId String
  project   DemoProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
  workerId  String
  worker    Worker      @relation(fields: [workerId], references: [id])

  @@unique([projectId, workerId])
}

model ProjectTruck {
  id        String      @id @default(cuid())
  projectId String
  project   DemoProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
  truckId   String
  truck     Truck       @relation(fields: [truckId], references: [id])

  @@unique([projectId, truckId])
}

model ProjectChat {
  id        String      @id @default(cuid())
  projectId String
  project   DemoProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
  role      String      // "user" | "ai"
  text      String      @db.Text
  timestamp DateTime    @default(now())

  @@index([projectId, timestamp])
}

enum ProjectPhase {
  PLANNING
  ACTIVE_DEMO
  CARTING
  CLEANUP
  COMPLETE
}

// ─────────────────────────────────────────────────────────
// CONFIRMATIONS
// ─────────────────────────────────────────────────────────

model Confirmation {
  id        String             @id @default(cuid())
  jobId     String
  job       CartingJob         @relation(fields: [jobId], references: [id])
  channel   ConfirmChannel
  status    ConfirmStatus      @default(PENDING)
  sentAt    DateTime?
  deliveredAt DateTime?
  failedAt  DateTime?
  failReason String?

  // Twilio/provider reference IDs
  externalId String?

  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  @@index([jobId])
}

enum ConfirmChannel {
  CALL
  EMAIL
  SMS
}

enum ConfirmStatus {
  PENDING
  SENT
  DELIVERED
  OPENED
  FAILED
}

// ─────────────────────────────────────────────────────────
// ROUTES
// ─────────────────────────────────────────────────────────

model Route {
  id             String      @id @default(cuid())
  truckId        String
  truck          Truck       @relation(fields: [truckId], references: [id])
  date           DateTime    @db.Date
  optimizedPath  Json?       // GeoJSON or array of coordinates
  actualPath     Json?       // GPS trace from IntelliShift
  totalDistance   Float?     // miles
  totalDuration   Float?    // minutes
  deviationCount Int        @default(0)

  stops          RouteStop[]

  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  @@unique([truckId, date])
}

model RouteStop {
  id        String     @id @default(cuid())
  routeId   String
  route     Route      @relation(fields: [routeId], references: [id], onDelete: Cascade)
  jobId     String
  job       CartingJob @relation(fields: [jobId], references: [id])
  sequence  Int        // Order in route
  eta       DateTime?
  arrivedAt DateTime?
  departedAt DateTime?

  @@index([routeId, sequence])
}

// ─────────────────────────────────────────────────────────
// CHANGE LOG / AUDIT
// ─────────────────────────────────────────────────────────

model ChangeLog {
  id         String   @id @default(cuid())
  entityType String   // "job", "worker", "truck", "project", "intake"
  entityId   String
  entityName String
  field      String
  oldValue   String?
  newValue   String?
  userId     String?  // Auth user who made the change
  userName   String?

  // Optional link to job
  jobId      String?
  job        CartingJob? @relation(fields: [jobId], references: [id])

  timestamp  DateTime @default(now())

  @@index([entityType, entityId])
  @@index([timestamp])
}

// ─────────────────────────────────────────────────────────
// INTEGRATION CONFIGS
// ─────────────────────────────────────────────────────────

model IntegrationConfig {
  id        String   @id @default(cuid())
  name      String   @unique  // "intellishift", "twilio", "outlook", "ralco"
  config    Json     // Encrypted config blob
  status    String   @default("disconnected") // "connected", "disconnected", "pending"
  lastSync  DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
